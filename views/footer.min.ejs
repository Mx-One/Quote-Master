</body>

<script>

let date=(new Date).toISOString().split("T")[0];let quoteNumber;let projectAddress;let clientName;document.getElementById("date-input").placeholder=date;const selectElement=document.querySelector(".project-info");selectElement.addEventListener("change",updateValue);function updateValue(e){if(e.target.id=="quote-number"){quoteNumber=e.target.value}else if(e.target.id=="date-input"){date=e.target.value}else if(e.target.id=="project-address"){projectAddress=e.target.value}else if(e.target.id=="client-name"){clientName=e.target.value}}const data=[];const uniqueData=[];let slabSupplyData=[];let slabWorkData=[];let printData=[];let slabSupplyDataCopy=[];let page=0;const csvSheet=jspreadsheet(document.getElementById("spreadsheet"),{data:data,columns:[{type:"text",title:"Location",width:120},{type:"text",title:"Product",width:200},{type:"text",title:"Material",width:200},{type:"numeric",title:"Length (in)",width:100},{type:"numeric",title:"Width (in)",width:100},{type:"numeric",title:"SF",width:100}],wordWrap:true,defaultRowHeight:30,columnSorting:false});const uniqueSheet=jspreadsheet(document.getElementById("spreadsheet-unique"),{data:uniqueData,columns:[{type:"text",title:"Location",width:120},{type:"text",title:"Product",width:200},{type:"text",title:"Material",width:200},{type:"numeric",title:"SF",width:100}],wordWrap:true,defaultRowHeight:30,columnSorting:false});const unique=(arr,vlookup)=>{let arrData=[];for(i=0;i<arr.length;i++){arrData.push([arr[i][0],arr[i][1],arr[i][2]])}let set=new Set(arrData.map(JSON.stringify));arrData=Array.from(set).map(JSON.parse);vLookup(arrData,data)};function vLookup(arr1,arr2){const lookArr=[];let sum=0;for(i=0;i<arr1.length;i++){for(y=0;y<arr2.length;y++){if(arr1[i][0]==arr2[y][0])if(arr1[i][1]==arr2[y][1])if(arr1[i][2]==arr2[y][2]){sum+=Number(arr2[y][5])}}arr1[i].push(sum.toFixed(1));uniqueData.push(arr1[i]);sum=0}uniqueData.sort(sortingByFirstColumn)}const uniqueSlabs=(arr,vLookupSlabs)=>{let arrData=[];for(i=0;i<arr.length;i++){arrData.push([arr[i][2]])}let set=new Set(arrData.map(JSON.stringify));arrData=Array.from(set).map(JSON.parse);vLookupSlabs(arrData,arr)};function vLookupSlabs(arr1,arr2){const lookArr=[];let sum=0;for(i=0;i<arr1.length;i++){for(y=0;y<arr2.length;y++){if(arr1[i][0]==arr2[y][2]){sum+=Number(arr2[y][3])}}arr1[i].push("","",sum.toFixed(1));slabSupplyData.push(arr1[i]);sum=0}}function sortingByFirstColumn(a,b){if(a[0]===b[0]){return 0}else{return a[0]<b[0]?-1:1}}function trim(array){for(let i=0;i<array.length;i++){for(let y=0;y<array[i].length;y++){array[i][y]=array[i][y].trim()}}}function dataCleaning(){data.length=0;uniqueData.length=0;slabSupplyData.length=0;slabWorkData.length=0}function dataHiding(){$("#tables").addClass("hide");$("#calc-tables").addClass("hide")}$("#submit-file").on("click",function(e){e.preventDefault();$("#files").parse({config:{delimiter:"auto",complete:displaySpreadsheet},before:function(file,inputElem){console.log("Parsing file...",file);dataHiding()},error:function(err,file){console.log("ERROR:",err,file)},complete:function(){console.log("Done with all files");page=0;$(".intro").addClass("hide");$(".or").addClass("hide");$("#new-quote-btn").addClass("hide");$("#cut-layout-btn").addClass("hide");$(".well-box").removeClass("well-box-start");$(".intro-text").css("margin-top","35px");$(".well-box").css("margin-top","5%");$(".row-box").css("margin-top","20px");$(".row-box").css("margin-bottom","20px");$(".row-box").css("width","800px");dataCleaning()}})});const displaySpreadsheet=(results,callback)=>{const start=new Promise((resolve,reject)=>{let x=results.data;if(x[x.length-1]=="");x.pop();resolve(x)});start.then(function(x){for(let i=0;i<x.length;i++){data.push(x[i][0].split(","))}}).then(function(){trim(data),document.getElementById("spreadsheet").jspreadsheet.refresh(),unique(data),document.getElementById("spreadsheet-unique").jspreadsheet.refresh()}).then(function(){$("#tables").removeClass("hide"),$(".bottom-btn").removeClass("hide")})};let newQuote=false;$("#new-quote-btn").click(()=>{$(".row-box").addClass("hide");$(".or").addClass("hide");$("#new-quote-btn").addClass("hide");$("#cut-layout-btn").addClass("hide");$("#next").addClass("hide");$("#back").addClass("hide");$(".well-box").removeClass("well-box-start");for(let i=0;i<4;i++){slabSupplyData.push(["","",""]);slabWorkData.push(["","",""])}supplySheet.refresh();workSheet.refresh();$(".intro-text").css("margin-top","35px");$(".intro").addClass("hide");$(".well-box").css("margin-top","0");$(".row-box").css("margin-top","20px");$(".row-box").css("margin-bottom","20px");$(".bottom-btn").removeClass("hide");$("#project-info-btn").removeClass("hide");$("#calc-tables").removeClass("hide");$(".print-options").removeClass("hide");$("#pdf-btn").removeClass("hide");newQuote=true;page=1});$("#next").click(()=>{if(page===0){$("#tables").addClass("hide");$("#next").addClass("hide");$(".row-box").addClass("hide");for(let i=0;i<uniqueData.length;i++){slabWorkData.push(uniqueData[i])}uniqueSlabs(uniqueData,vLookupSlabs);slabSupplyDataCopy.push(JSON.stringify(slabSupplyData));document.getElementById("slab-supply").jspreadsheet.refresh();document.getElementById("slab-work").jspreadsheet.refresh();$("#project-info-btn").removeClass("hide");$("#calc-tables").removeClass("hide");$(".print-options").removeClass("hide");$("#pdf-btn").removeClass("hide");$(".well-box").css("margin-top","0");page++}});$("#back").click(()=>{if(page===1){$("#tables").removeClass("hide");$("#next").removeClass("hide");$(".row-box").removeClass("hide");$("#project-info-btn").addClass("hide");$(".project-info").addClass("hide");$("#calc-tables").addClass("hide");$("#pdf-btn").addClass("hide");$(".print-options").addClass("hide");slabSupplyData.length=0;slabWorkData.length=0;page--;$(".well-box").css("margin-top","5%")}if(page===2){$("#calc-tables").removeClass("hide");$("#pdf-btn").removeClass("hide");$(".print-options").removeClass("hide");document.body.style.backgroundColor="#F7F7F7";$("#to-pdf").addClass("hide");if(newQuote){$("#back").addClass("hide")}$("#multiple-spreadsheets").remove();$(".well-box").removeClass("auto-width");noBreak=true;secondPage=false;slabSupplyPrinted=false;slabSupplyLines=0;linesPerPage=18;slabWorkTextPrinted=false;startFromTheSecondPage=false;slabText=0;printTotal=false;page--}});$(".logo").click(()=>{location.reload()});$("#pdf-btn").click(()=>{totalAmount=0;if(page===1){$("#multiple-spreadsheets").remove();$("#calc-tables").addClass("hide");$(".print-options").addClass("hide");$(".well-box").addClass("auto-width");$("#to-pdf").removeClass("hide");$("#back").removeClass("hide");const divToPdf=document.createElement("div");divToPdf.setAttribute("id","multiple-spreadsheets");document.getElementById("to-pdf-second-layer").appendChild(divToPdf);page++;convertToPrintData()}if(!date){date=(new Date).toISOString().split("T")[0]}if(!quoteNumber){quoteNumber=" "}if(!projectAddress){projectAddress=" "}if(!clientName){clientName=" "}$("#date").html("DATE: "+date);$("#quote-num").html("QUOTE #: "+quoteNumber);$("#project-name").html("PROJECT: "+projectAddress);$("#customer").html("CUSTOMER: "+clientName);if(!printSlabSupply){opt.filename=projectAddress+" - Stone work quote ("+quoteNumber+")"}else if(!printSlabWork){opt.filename=projectAddress+" - Stone supply quote ("+quoteNumber+")"}else{opt.filename=projectAddress+" - Stone supply and work quote ("+quoteNumber+")"}document.body.style.backgroundColor="#FFF5E1";toPDF()});$("#project-info-btn").click(()=>{if($(".project-info").hasClass("hide")){$(".project-info").removeClass("hide")}else if(!$(".project-info").hasClass("hide")){$(".project-info").addClass("hide")}});$("#addRow").click(()=>{workSheet.insertRow()});$("#deleteRow").click(()=>{workSheet.setMerge("A3",2,1)});let printSlabSupply=true;let printSlabWork=true;$(".slab-supply-table-checkbox").change(function(){if($(this).is(":checked")){$("#slab-supply").removeClass("hide");$("#slab-supply-header").css("color","black");$(".slab-supply input:checkbox").prop("checked",true);$(".slab-supply input:checkbox").prop("disabled",false);printSlabSupply=true}else{$("#slab-supply").addClass("hide");$("#slab-supply-header").css("color","grey");$(".slab-supply input:checkbox").prop("checked",false);$(".slab-supply input:checkbox").prop("disabled",true);printSlabSupply=false}});$(".slab-work-table-checkbox").change(function(){if($(this).is(":checked")){$("#slab-work").removeClass("hide");$("#slab-work-header").css("color","black");$(".slab-work input:checkbox").prop("checked",true);$(".slab-work input:checkbox").prop("disabled",false);printSlabWork=true}else{$("#slab-work").addClass("hide");$("#slab-work-header").css("color","grey");$(".slab-work input:checkbox").prop("checked",false);$(".slab-work input:checkbox").prop("disabled",true);printSlabWork=false}});$(".slab-supply input:checkbox").change(function(){if($(this).is(":checked")){printSlabSupply=true}else{printSlabSupply=false}});$(".slab-work input:checkbox").change(function(){if($(this).is(":checked")){printSlabWork=true}else{printSlabWork=false}});function testJSON(text){try{JSON.parse(text);return true}catch(error){return false}}const changedSlabs=function(instance,cell,x,y,value){const rowNumber=Number(jexcel.getColumnNameFromId([x,y]).substring(1));if(slabSupplyData[rowNumber-1][4]){slabSupplyData[rowNumber-1][7]=slabSupplyData[rowNumber-1][4]*Number(slabSupplyData[rowNumber-1][5].replace(/[^\d.]/g,""));slabSupplyData[rowNumber-1][8]=slabSupplyData[rowNumber-1][4]*Number(slabSupplyData[rowNumber-1][6].replace(/[^\d.]/g,""));supplySheet.refresh()}if(x==0){let slabSupplyDataCopyParsed;if(testJSON(slabSupplyDataCopy)){slabSupplyDataCopyParsed=JSON.parse(slabSupplyDataCopy)}if(slabSupplyDataCopyParsed){for(let i=0;i<slabWorkData.length;i++){if(String(slabSupplyDataCopyParsed[y][0]).toLocaleLowerCase()==String(slabWorkData[i][2]).toLowerCase()){slabWorkData[i][2]=slabSupplyData[y][0]}}changedWork();workSheet.refresh()}}};const jobSite=1;const sfPrice=50*jobSite;const materialType=1;const edgeProfile=1;const waterfall=0;const sink_cooktop=0;function dynamicVLookUpSlabs(slabSupplyData,slabWorkData){let sum=0;for(i=0;i<slabSupplyData.length;i++){for(y=0;y<slabWorkData.length;y++){if(String(slabSupplyData[i][0]).toLowerCase()==String(slabWorkData[y][2]).toLowerCase()){sum+=Number(slabWorkData[y][3])}}slabSupplyData[i][3]=sum.toFixed(1);sum=0}}const changedWork=function(instance,cell,x,y,value){if(x==2){const tempArr=[];for(i=0;i<slabSupplyData.length;i++){if(slabSupplyData[i][0]){tempArr.push(slabSupplyData[i][0])}}if(slabSupplyData.map(col=>col[0]).every(mat=>String(mat).toLowerCase()!==String(value).toLowerCase())){tempArr.push(value)}slabSupplyData.length=0;for(y=0;y<tempArr.length;y++){slabSupplyData.push([tempArr[y]])}dynamicVLookUpSlabs(slabSupplyData,slabWorkData);supplySheet.refresh()}if(x==3||x==4||x==5||x==6||x==7||x==8){if(x==3){dynamicVLookUpSlabs(slabSupplyData,slabWorkData);supplySheet.refresh()}const rowNumber=Number(jexcel.getColumnNameFromId([x,y]).substring(1));if(slabWorkData[rowNumber-1][3]){const calculation=new Promise((resolve,reject)=>{let sum=slabWorkData[rowNumber-1][3]*sfPrice;switch(slabWorkData[rowNumber-1][4]){case"Quartz":sum*=materialType;break;case"Marble":sum*=materialType+.1;break;case"Quartzite":sum*=materialType+.2;break;case"Porcelain":sum*=materialType+.2;break}switch(slabWorkData[rowNumber-1][5]){case"Pencil edge":sum*=edgeProfile;break;case'1.5" Mitered':sum*=edgeProfile+.2;break;case'2" Mitered':sum*=edgeProfile+.2;break;case"Mitered":sum*=edgeProfile+.2;break}switch(slabWorkData[rowNumber-1][6]){case"No":sum+=waterfall;break;case"1":sum+=waterfall+1e3;break;case"2":sum+=waterfall+1500;break;case"3":sum+=waterfall+2e3;break;case"4":sum+=waterfall+2500;break}switch(slabWorkData[rowNumber-1][7]){case"No":sum+=sink_cooktop;break;case"Sink cutout":sum+=sink_cooktop+250;break;case"Cooktop cutout":sum+=sink_cooktop+200;break;case"S+C cutouts":sum+=sink_cooktop+450;break;case"Integrated sink":sum+=sink_cooktop+2500;break;case"Integ. sink + Cooktop cutouts":sum+=waterfall+2800;break}if(slabWorkData[rowNumber-1][8]!==""){const value=slabWorkData[rowNumber-1][8].replace(/[^\d/.-]/g,"");sum+=Number(value)}resolve(sum)});calculation.then(function(sum){slabWorkData[rowNumber-1][9]=sum.toFixed(2),workSheet.refresh()})}if(!slabWorkData[rowNumber-1][3]){if(slabWorkData[rowNumber-1][8]!==""){const value=slabWorkData[rowNumber-1][8].replace(/[^\d/.-]/g,"");const sum=Number(value);slabWorkData[rowNumber-1][9]=sum.toFixed(2),workSheet.refresh()}}}slabSupplyDataCopy.length=0;slabSupplyDataCopy.push(JSON.stringify(slabSupplyData))};const SUMCOL=function(instance,columnId){let total=0;for(let j=0;j<instance.options.data.length;j++){const value=instance.records[j][columnId].innerHTML.replace(/[^\d/.-]/g,"");if(value!==""){total+=Number(value)}}return numberFormatter("$ #,###.00",total)};const supplySheet=jspreadsheet(document.getElementById("slab-supply"),{data:slabSupplyData,columns:[{type:"text",title:"Slab name",width:200},{type:"text",title:"Finish",width:100},{type:"text",title:"Supplier",width:100},{type:"numeric",title:"SF",width:100},{type:"numeric",title:"Slabs q-ty",width:100},{type:"numeric",title:"Our price",width:100,mask:"$ #,##.00",decimal:"."},{type:"numeric",title:"Selling price",width:100,mask:"$ #,##.00",decimal:"."},{type:"numeric",title:"Our TOTAL",width:100,mask:"$ #,##.00",decimal:"."},{type:"numeric",title:"Client's TOTAL",width:100,mask:"$ #,##.00",decimal:"."},{type:"text",title:"Notes",width:200}],wordWrap:true,defaultRowHeight:30,footers:[["Total","","","","","","","=SUMCOL(TABLE(), 7)","=SUMCOL(TABLE(), 8)"]],columnSorting:false,onchange:changedSlabs});const workSheet=jspreadsheet(document.getElementById("slab-work"),{data:slabWorkData,columns:[{type:"text",title:"Location",width:120},{type:"text",title:"Product",width:200},{type:"text",title:"Material",width:200},{type:"numeric",title:"SF",width:100},{type:"dropdown",title:"Material type",width:100,source:["Quartz","Marble","Quartzite","Porcelain"]},{type:"dropdown",title:"Edge",width:100,source:["Pencil edge",'1.5" Mitered','2" Mitered',"Mitered"]},{type:"dropdown",title:"Waterfall",width:100,source:["No","1","2","3","4"]},{type:"dropdown",title:"Sink/Cooktop",width:150,source:["No","Sink cutout","Cooktop cutout","S+C cutouts","Integrated sink","Integ. sink + Cooktop cutouts"]},{type:"numeric",title:"Extra $",width:100,mask:"$ #,##.00",decimal:"."},{type:"numeric",title:"Labour price",width:150,mask:"$ #,##.00",decimal:"."},{type:"text",title:"Notes",width:200}],wordWrap:true,defaultRowHeight:30,footers:[["Total","","","","","","","","","=SUMCOL(TABLE(), 9)"]],columnSorting:false,onchange:changedWork});const pdfDiv=document.getElementById("to-pdf");const opt={margin:.3,filename:"myfile.pdf",image:{type:"jpeg",quality:1},html2canvas:{scale:4,scrollY:0},jsPDF:{unit:"in",format:"letter",orientation:"landscape"},pagebreak:{before:[".break",".break-text"],avoid:[".container-total","tr"]}};function toPDF(){html2pdf().set(opt).from(pdfDiv).toPdf().get("pdf").then(function(pdf){var totalPages=pdf.internal.getNumberOfPages();for(i=1;i<=totalPages;i++){pdf.setPage(i);pdf.setFontSize(10);pdf.setTextColor(100);pdf.text("Page "+i+" of "+totalPages,pdf.internal.pageSize.getWidth()/2.3,pdf.internal.pageSize.getHeight()-.3)}}).save()}function countRowLines(array){const rowLines=[];for(let i=0;i<array.length;i++){let rowCount=0;for(let y=0;y<array[i].length;y++){if(array[i][y].toString().match(/\n/g)){if(array[i][y].toString().match(/\n/g).length>rowCount){rowCount=array[i][y].toString().match(/\n/g).length}}}rowCount++;rowLines.push(rowCount)}countingRows(rowLines,array)}let slabSupplyPrinted=false;let slabSupplyLines=0;let linesPerPage=18;let noBreak=true;let secondPage=false;let slabWorkTextPrinted=false;let slabText=0;let startFromTheSecondPage=false;let printTotal=false;function evalLines(num){if(num>1){return(num-1)*.7+1}else{return num}}function countingRows(rowLinesArr,array){let lines=0+slabSupplyLines;let rowsCount=0;if(slabSupplyLines>=13&&slabSupplyLines<=19){startFromTheSecondPage=true;lines=0;linesPerPage=28}for(let i=0;i<rowLinesArr.length;i++){if(secondPage){linesPerPage=28}lines+=evalLines(rowLinesArr[i]);if(lines+evalLines(rowLinesArr[i+1])>=linesPerPage-slabText){pushMe(array.slice(rowsCount,i+1));rowsCount=i+1;lines=0;slabText=0;secondPage=true}if(i===rowLinesArr.length-1){if(secondPage){linesPerPage=28}if(!printTotal){printTotal=true}pushMe(array.slice(rowsCount,i+1));if(!slabSupplyPrinted&&!secondPage){slabSupplyLines=lines-rowsCount}else if(!slabSupplyPrinted&&secondPage){slabSupplyLines=lines}slabSupplyPrinted=true;noBreak=true}}}function convertToPrintData(){const startPrint=new Promise((resolve,reject)=>{if(printSlabSupply){printData=slabSupplyData.map(arr=>[arr[0],arr[1],arr[2],arr[4],arr[6],arr[8],arr[9]]);countRowLines(printData)}resolve(console.log("slab supply data is printed"))});startPrint.then(function(){slabSupplyPrinted=true;printData.length=0,printSlabWorkTable(),addNumbersToTotals()})}function printSlabWorkTable(){if(printSlabWork){printData=slabWorkData.map(arr=>[arr[0],arr[1],arr[2],arr[5],arr[9],arr[10]]),slabText=3;countRowLines(printData)}}let totalAmount=0;let discountAmount=0;let totalAfterDiscountAmount;function addNumbersToTotals(){totalAfterDiscountAmount=totalAmount-discountAmount;$("#total-amount").text(numberFormatter("$ #,###.00",totalAmount));$("#discount-amount").text(numberFormatter("$ #,###.00",discountAmount));$("#total-after-discount-amount").text(numberFormatter("$ #,###.00",totalAmount-discountAmount));$("#hst-amount").text(numberFormatter("$ #,###.00",totalAfterDiscountAmount*.13));$("#grand-total-amount").text(numberFormatter("$ #,###.00",totalAfterDiscountAmount+totalAfterDiscountAmount*.13))}const sumUpAmount=function(array,column){let sum=0;for(let i=0;i<array.length;i++){let value=array[i][column];if(value!==""){if(isNaN(value)){value=value.replace(/[^\d.]/g,"")}sum+=Number(value)}}$("#total-amount").text(totalAmount);totalAmount+=sum;return numberFormatter("$ #,###.00",sum)};function pushMe(array){let newTable=document.createElement("div");let slabSupplyText=document.createElement("h4");if(!noBreak){newTable.setAttribute("class","break")}if(!slabSupplyPrinted&&printSlabSupply){if(printTotal){array.push(["Total","","","","","",""])}const printSheet=jspreadsheet(newTable,{data:array,columns:[{type:"text",title:"Slab name",width:200},{type:"text",title:"Finish",width:100},{type:"text",title:"Supplier",width:100},{type:"numeric",title:"Slabs q-ty",width:100},{type:"numeric",title:"Price",width:100,mask:"$ #,##.00",decimal:"."},{type:"numeric",title:"Amount",width:100,mask:"$ #,##.00",decimal:"."},{type:"text",title:"Notes",width:200}],wordWrap:true,defaultRowHeight:25,updateTable:function(instance,cell,col,row,val,label,cellName){if(cell.innerHTML=="Total"){cell.parentNode.style.backgroundColor="#F3F3F3"}}});printSheet.hideIndex();if(printTotal&&printSlabSupply){printSheet.setMerge("A"+array.length,5,1);printSheet.resetSelection(true);printSheet.setValue("F"+array.length,sumUpAmount(printData,5));printTotal=false}}else{if(printTotal){array.push(["Total","","","","",""])}const printSheet=jspreadsheet(newTable,{data:array,columns:[{type:"text",title:"Location",width:120},{type:"text",title:"Product",width:200},{type:"text",title:"Material",width:200},{type:"text",title:"Edge",width:100},{type:"numeric",title:"Amount",width:150,mask:"$ #,##.00",decimal:"."},{type:"text",title:"Notes",width:200}],wordWrap:true,defaultRowHeight:25,updateTable:function(instance,cell,col,row,val,label,cellName){if(cell.innerHTML=="Total"){cell.parentNode.style.backgroundColor="#F3F3F3"}}});printSheet.hideIndex();if(printTotal&&printSlabWork){printSheet.setMerge("A"+array.length,4,1);printSheet.resetSelection(true);printSheet.setValue("E"+array.length,sumUpAmount(printData,4));printTotal=false}secondPage=true}if(noBreak&&!slabSupplyPrinted&&printSlabSupply){document.getElementById("multiple-spreadsheets").appendChild(slabSupplyText);slabSupplyText.innerHTML="Slab supply";slabText=0}else if(!slabWorkTextPrinted&&slabSupplyPrinted){if(startFromTheSecondPage){slabSupplyTextDiv=document.createElement("div");document.getElementById("multiple-spreadsheets").appendChild(slabSupplyTextDiv);slabSupplyTextDiv.setAttribute("class","break-text");newTable.removeAttribute("class","break");startFromTheSecondPage=false}slabWorkTextPrinted=true;document.getElementById("multiple-spreadsheets").appendChild(slabSupplyText);slabSupplyText.innerHTML="Slab work";slabText=0}let element=document.getElementById("multiple-spreadsheets");element.appendChild(newTable);noBreak=false}

</script>


</html>
